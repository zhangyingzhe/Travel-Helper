package com.example.zyz.hw9android;import android.app.ProgressDialog;import android.content.Context;import android.content.Intent;import android.net.Uri;import android.os.Bundle;import android.support.annotation.NonNull;import android.support.v4.app.Fragment;import android.util.Log;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.AdapterView;import android.widget.AutoCompleteTextView;import android.widget.Button;import android.widget.EditText;import android.widget.RadioGroup;import android.widget.Spinner;import android.widget.TextView;import android.widget.Toast;import com.android.volley.Request;import com.android.volley.RequestQueue;import com.android.volley.Response;import com.android.volley.VolleyError;import com.android.volley.toolbox.StringRequest;import com.android.volley.toolbox.Volley;import com.google.android.gms.location.places.AutocompleteFilter;import com.google.android.gms.location.places.AutocompletePredictionBufferResponse;import com.google.android.gms.location.places.GeoDataClient;import com.google.android.gms.location.places.Place;import com.google.android.gms.location.places.Places;import com.google.android.gms.location.places.ui.PlaceAutocomplete;import com.google.android.gms.tasks.OnCompleteListener;import com.google.android.gms.tasks.Task;import static android.app.Activity.RESULT_OK;import static android.net.Uri.encode;public class SearchFragment extends Fragment {    private final String TAG="SearchFragment";    Button searchButton;    Button clearButton;    private View view;    public static final String EXTRA_MESSAGE = "com.example.zyz.hw9android.MESSAGE";    String nearby_url = "http://csci571yingzhez-env.us-east-2.elasticbeanstalk.com/nearby_search?distance=16093.44&category=default&keyword=usc&location=34.0266,-118.2831";    private static final int AUTO_COMP_REQ_CODE = 2;    ProgressDialog pd;    EditText keywordText;    EditText distanceText;    AutoCompleteTextView searchPlace;    RadioGroup radio;    Spinner spinner;    String location;    TextView keywordError;    TextView locationError;    String[] types = {"default","airport","amusement_park","aquarium","art_gallery","bakery","bar",    "beauty_salon","bowling_alley","bus_station","cafe","campground","car_rental","casino","lodging",    "movie_theater","museum","night_club","park","parking","restaurant","shopping_mall","stadium",    "subway_station","taxi_stand","train_station","transit_station","travel_agency","zoo"};    protected GeoDataClient geoDataClient;    public SearchFragment() {        // Required empty public constructor    }    public static SearchFragment newInstance() {        SearchFragment fragment = new SearchFragment();        return fragment;    }    @Override    public void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);    }    @Override    public View onCreateView(LayoutInflater inflater, ViewGroup container,                             Bundle savedInstanceState) {        // Inflate the layout for this fragment        view = inflater.inflate(R.layout.fragment_search, container, false);        pd = new ProgressDialog(getActivity());        location = "";        keywordText = (EditText) view.findViewById(R.id.keyword);        distanceText = (EditText) view.findViewById(R.id.distance);        radio = (RadioGroup) view.findViewById(R.id.radioGroup);        spinner = (Spinner) view.findViewById(R.id.category_spinner);        keywordError = (TextView) view.findViewById(R.id.keyword_error);        locationError = (TextView) view.findViewById(R.id.location_error);        searchButton = (Button) view.findViewById(R.id.search_button);        searchButton.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                checkQuestData();            }        });        clearButton = (Button) view.findViewById(R.id.clear_button);        clearButton.setOnClickListener(new View.OnClickListener() {            @Override            public void onClick(View view) {                ClearActivity(view);            }        });        searchPlace = view.findViewById(R.id.autoCompleteTextView);        CustomAutoCompleteAdapter adapter =  new CustomAutoCompleteAdapter(getActivity());        searchPlace.setAdapter(adapter);        searchPlace.setOnItemClickListener(onItemClickListener);        searchPlace.setEnabled(false);        radio.setOnCheckedChangeListener(new RadioGroup.OnCheckedChangeListener() {            @Override            public void onCheckedChanged(RadioGroup radioGroup, int i) {                if(i == R.id.radioButton){                    searchPlace.setEnabled(false);                }                if(i == R.id.radioButton2){                    searchPlace.setEnabled(true);                }            }        });        return view;    }    private AdapterView.OnItemClickListener onItemClickListener =            new AdapterView.OnItemClickListener(){                @Override                public void onItemClick(AdapterView<?> adapterView, View view, int i, long l) {                    location = ((com.example.zyz.hw9android.Place)adapterView.                            getItemAtPosition(i)).getPlaceText();                }            };    public void ClearActivity(View view){        keywordError.setVisibility(View.GONE);        locationError.setVisibility(View.GONE);        keywordText.getText().clear();        distanceText.getText().clear();        spinner.setSelection(0);        searchPlace.getText().clear();        searchPlace.setEnabled(false);        radio.check(R.id.radioButton);    }    public void checkQuestData(){        boolean hasError = false;        String keyword = keywordText.getText().toString();        if(keyword.trim().isEmpty()) {            keywordError.setVisibility(View.VISIBLE);            showErrorToast();            hasError = true;        }        Double distance = 10.0;        String dis = distanceText.getText().toString();        if(!dis.isEmpty()){            distance = Double.valueOf(dis);        }        distance = distance * 1609.344;        int loca = radio.getCheckedRadioButtonId();        int  typeidx = spinner.getSelectedItemPosition();        String loc = null;        if(loca == R.id.radioButton2){            Log.e(TAG,"cur location");            loc = searchPlace.getText().toString();            if(loc.trim().isEmpty()) {                locationError.setVisibility(View.VISIBLE);                showErrorToast();                hasError = true;            }        }else{            loc = "34.0266,-118.2831";        }        if(hasError){            return;        }        String url = getString(R.string.server_path) + "nearby_search?distance=" + distance +                "&category=" + types[typeidx] + "&keyword=" + keyword.replaceAll(" ","%20")+                "&location=" + loc.replaceAll(" ","%20");        if(loca == R.id.radioButton2){            url += "&needGetGeo=true";        }        Log.e(TAG,url);        sendSearch(url);    }    private void showErrorToast() {        Toast.makeText(getActivity(),"Please fix all fields with errors",Toast.LENGTH_SHORT).show();    }    public void sendSearch(String url) {        pd.setMessage("Fetching results");        pd.show();        RequestQueue queue = Volley.newRequestQueue(getActivity());        StringRequest stringRequest = new StringRequest(Request.Method.GET,url, new Response.Listener<String>() {            @Override            public void onResponse(String response) {                //Log.i("MainActivity",response);                sendSearchCallback(response);            }        }, new Response.ErrorListener() {            @Override            public void onErrorResponse(VolleyError error) {                Log.e(TAG,"sendsearch error");                error.printStackTrace();            }        });        queue.add(stringRequest);    }    private void sendSearchCallback(String response){        Intent intent = new Intent(getActivity(), SearchActivity.class);        intent.putExtra(EXTRA_MESSAGE, response);        pd.dismiss();        startActivity(intent);    }    @Override    public void onResume() {        super.onResume();        ClearActivity(view);    }}